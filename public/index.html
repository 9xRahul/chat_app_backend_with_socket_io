<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Chat App Backend — API Documentation</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f172a;
            --card: #0b1220;
            --muted: #94a3b8;
            --accent: #60a5fa;
            --glass: rgba(255, 255, 255, 0.03);
            --white: #e6eef8;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial;
        }

        body {
            background: linear-gradient(180deg, #071022 0%, #071a2b 100%);
            color: var(--white);
            padding: 28px;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        .card {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            border-radius: 14px;
            padding: 22px;
            box-shadow: 0 6px 30px rgba(2, 6, 23, 0.6);
        }

        h1 {
            margin: 0 0 8px;
            font-size: 22px;
            color: var(--accent);
        }

        p.lead {
            margin: 0 0 18px;
            color: var(--muted);
        }

        .row {
            display: flex;
            gap: 18px;
            flex-wrap: wrap;
        }

        .col {
            flex: 1;
            min-width: 260px;
        }

        .section {
            margin-top: 18px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.03);
        }

        pre,
        code {
            background: #031024;
            border-radius: 8px;
            padding: 10px;
            color: var(--white);
            font-size: 13px;
            overflow: auto;
        }

        pre.example {
            max-height: 260px;
        }

        .endpoint {
            background: linear-gradient(90deg, rgba(96, 165, 250, 0.08), rgba(96, 165, 250, 0.02));
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .method {
            display: inline-block;
            padding: 6px 8px;
            border-radius: 6px;
            font-weight: 700;
            margin-right: 8px;
        }

        .GET {
            background: #145;
            color: #b6f0d6;
        }

        .POST {
            background: #124;
            color: #bfe7ff;
        }

        .notes {
            color: var(--muted);
            font-size: 13px;
            margin-top: 8px;
        }

        .badge {
            display: inline-block;
            padding: 6px 8px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.03);
            font-size: 13px;
            margin-right: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
        }

        th,
        td {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            text-align: left;
            font-size: 13px;
            color: var(--white);
        }

        th {
            color: var(--accent);
            font-weight: 600;
        }

        footer {
            margin-top: 22px;
            color: var(--muted);
            font-size: 13px;
        }

        .copy-btn {
            display: inline-block;
            margin-left: 8px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.04);
            padding: 6px 8px;
            border-radius: 6px;
            color: var(--accent);
            cursor: pointer;
        }

        .small {
            font-size: 13px;
            color: var(--muted);
        }

        .danger {
            color: #ff9b9b
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="card">
            <h1>Chat App Backend — API Documentation</h1>
            <p class="lead">REST + Socket.IO endpoints for the Flutter chat application. Replace
                <code>&lt;BASE&gt;</code> with your server base URL (e.g.
                <code>https://chat-app-backend-with-socket-io.onrender.com</code>).
            </p>

            <div class="row">
                <div class="col">
                    <div class="section">
                        <h2>Authentication</h2>

                        <div class="endpoint">
                            <span class="method POST">POST</span> <strong>/api/auth/register</strong>
                            <div class="small">Create a new user</div>
                            <pre class="example">Request JSON
{
  "name": "Alice",
  "email": "alice@example.com",
  "password": "password123"
}
Response 200
{
  "token": "<JWT_TOKEN>",
  "user": { "id": "<userId>", "name": "Alice", "email": "alice@example.com", "avatar": null }
}</pre>
                        </div>

                        <div class="endpoint">
                            <span class="method POST">POST</span> <strong>/api/auth/login</strong>
                            <div class="small">Login and receive JWT</div>
                            <pre class="example">Request JSON
{
  "email": "alice@example.com",
  "password": "password123"
}
Response 200
{
  "token": "<JWT_TOKEN>",
  "user": { "id": "<userId>", "name": "Alice", "email": "alice@example.com" }
}</pre>
                        </div>

                        <p class="notes">Use the returned <code>token</code> in the
                            <code>Authorization: Bearer &lt;token&gt;</code> header for protected endpoints and as
                            Socket.IO handshake auth: <code>auth: { token }</code>.
                        </p>
                    </div>

                    <div class="section">
                        <h2>Users</h2>

                        <div class="endpoint">
                            <span class="method GET">GET</span> <strong>/api/users/me</strong>
                            <div class="small">Get current authenticated user</div>
                            <pre class="example">Headers
Authorization: Bearer &lt;TOKEN&gt;

Response 200
{
  "user": { "id":"<id>", "name":"Alice", "email":"alice@example.com", "online": true, ... }
}</pre>
                        </div>

                        <div class="endpoint">
                            <span class="method GET">GET</span> <strong>/api/users</strong>
                            <div class="small">List users except the logged-in user (supports pagination & search)</div>
                            <pre class="example">Query params
?q=&limit=20&page=1

Headers
Authorization: Bearer &lt;TOKEN&gt;

Response 200
{
  "users": [
    { "_id":"<bob_id>", "name":"Bob", "email":"bob@example.com", "online": false }
  ],
  "meta": { "total": 1, "page": 1, "limit": 20, "pages": 1 }
}</pre>
                        </div>

                    </div>

                    <div class="section">
                        <h2>Messages</h2>

                        <div class="endpoint">
                            <span class="method POST">POST</span> <strong>/api/messages</strong>
                            <div class="small">Send a message (REST) — server saves and emits to recipient if online
                            </div>
                            <pre class="example">Headers
Authorization: Bearer &lt;TOKEN&gt;

Body JSON
{
  "to": "<recipient_user_id>",
  "text": "Hello Bob!"
}

Response 200
{
  "message": {
    "_id": "<messageId>",
    "from": "<senderId>",
    "to": "<recipientId>",
    "text": "Hello Bob!",
    "createdAt": "2025-09-14T..."
  }
}</pre>
                        </div>

                        <div class="endpoint">
                            <span class="method GET">GET</span> <strong>/api/messages/conversation/:userId</strong>
                            <div class="small">Get conversation with a user. Supports pagination via <code>limit</code>
                                and <code>before</code> (ISO timestamp). Returns messages ordered oldest → newest.</div>
                            <pre class="example">Example
GET /api/messages/conversation/68c6bbd86b1d1098da88a585?limit=20
Headers: Authorization: Bearer &lt;TOKEN&gt;

Response 200
{
  "messages": [
    { "_id":"<id>", "from":{ "_id":"...", "name":"Alice" }, "to":{...}, "text":"...", "createdAt":"..." }
  ]
}

Load older pages:
GET /api/messages/conversation/:userId?limit=20&before=2025-09-14T12:34:56.000Z
</pre>
                        </div>

                        <p class="notes">UI pattern: request latest page first (no <code>before</code>); on scroll up
                            use earliest message <code>createdAt</code> as <code>before</code> to fetch older messages
                            (prepend to list).</p>

                    </div>

                </div>

                <div class="col">
                    <div class="section">
                        <h2>Socket.IO (Realtime)</h2>

                        <p class="small">Connect using Socket.IO client and pass the token in the handshake
                            <code>auth</code> object. Example (JS):
                        </p>
                        <pre class="example">
// Browser or Node (socket.io-client)
const socket = io('https://your-base-url', {
  transports: ['websocket'],
  auth: { token: 'YOUR_JWT_TOKEN' }
});

socket.on('connect', () => console.log('connected', socket.id));
socket.on('connect_error', (err) => console.error('connect_error', err));
socket.on('private_message', (data) => console.log('private_message', data));
socket.on('user_online', (d) => console.log('user_online', d));
          </pre>

                        <h3>Events (emit / listen)</h3>
                        <table>
                            <tr>
                                <th>Event</th>
                                <th>Direction</th>
                                <th>Payload</th>
                                <th>Notes</th>
                            </tr>
                            <tr>
                                <td><strong>private_message</strong></td>
                                <td>client → server</td>
                                <td>
                                    <pre>{ "to": "<userId>", "text": "hi" }</pre>
                                </td>
                                <td>Server saves message and emits to recipient & sender rooms. Accepts ack callback.
                                </td>
                            </tr>
                            <tr>
                                <td><strong>private_message</strong></td>
                                <td>server → client</td>
                                <td>
                                    <pre>{ "message": { "_id","from","to","text","createdAt" } }</pre>
                                </td>
                                <td>Delivered to recipient's room(s).</td>
                            </tr>
                            <tr>
                                <td><strong>typing</strong></td>
                                <td>client → server</td>
                                <td>
                                    <pre>{ "to":"<userId>", "typing": true }</pre>
                                </td>
                                <td>Server forwards to target user.</td>
                            </tr>
                            <tr>
                                <td><strong>user_online</strong></td>
                                <td>server → client</td>
                                <td>
                                    <pre>{ "userId":"<id>", "online": true }</pre>
                                </td>
                                <td>Broadcast when user goes online/offline.</td>
                            </tr>
                        </table>

                        <h3 class="small">Socket auth notes</h3>
                        <ul class="small">
                            <li>Server verifies JWT using <code>JWT_SECRET</code>. Use token returned from same server's
                                <code>/api/auth/login</code>.
                            </li>
                            <li>If you get <code>connect_error Authentication error</code>, re-login on the server and
                                use the returned token.</li>
                            <li>For Flutter use <code>socket_io_client</code> and set auth via
                                <code>OptionBuilder().setAuth({'token': token})</code>.
                            </li>
                        </ul>
                    </div>

                    <div class="section">
                        <h2>Schemas</h2>
                        <p class="small">Message document</p>
                        <pre>{
  "_id": "68c6d11d7fb975b1ed333d2f",
  "from": "68c6bbd86b1d1098da88a585",
  "to": "68c6bbd86b1d1098da88a585",
  "text": "Hello",
  "createdAt": "2025-09-14T14:28:45.108Z",
  "delivered": false,
  "seen": false
}</pre>

                        <p class="small">User document</p>
                        <pre>{
  "_id": "68c6bbd86b1d1098da88a585",
  "name": "Alice",
  "email": "alice@example.com",
  "online": true,
  "socketId": "j_xwLQ4WdSQaq_70AAAB",
  "socketIds": ["j_xw..."], // if multi-device support enabled
  "createdAt": "...",
  "updatedAt": "..."
}</pre>
                    </div>

                    <div class="section">
                        <h2>Errors & Status</h2>
                        <table>
                            <tr>
                                <th>Code</th>
                                <th>Meaning</th>
                            </tr>
                            <tr>
                                <td>200</td>
                                <td>OK</td>
                            </tr>
                            <tr>
                                <td>400</td>
                                <td>Bad request (validation failed)</td>
                            </tr>
                            <tr>
                                <td>401</td>
                                <td>Unauthorized (invalid/expired token)</td>
                            </tr>
                            <tr>
                                <td>403</td>
                                <td>Forbidden</td>
                            </tr>
                            <tr>
                                <td>500</td>
                                <td>Server error</td>
                            </tr>
                        </table>
                        <p class="small notes">Socket errors may appear as <code>connect_error</code> events with text
                            like <code>Authentication error</code> or <code>jwt expired</code>.</p>
                    </div>

                    <div class="section">
                        <h2>Quick curl & Postman snippets</h2>

                        <p class="small">Login (curl)</p>
                        <pre class="example">curl -s -X POST "&lt;BASE&gt;/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"email":"alice@example.com","password":"12345678"}'</pre>

                        <p class="small">Get users (curl)</p>
                        <pre
                            class="example">curl -H "Authorization: Bearer &lt;TOKEN&gt;" "&lt;BASE&gt;/api/users"</pre>

                        <p class="small">Send message (curl)</p>
                        <pre class="example">curl -X POST "&lt;BASE&gt;/api/messages" \
  -H "Authorization: Bearer &lt;TOKEN&gt;" \
  -H "Content-Type: application/json" \
  -d '{"to":"&lt;USER_ID&gt;","text":"hello"}'</pre>

                        <p class="small">Socket test (Node)</p>
                        <pre class="example">const io = require('socket.io-client');
const socket = io('&lt;BASE&gt;', { transports:['websocket'], auth: { token: '&lt;TOKEN&gt;' } });
socket.on('connect', () => console.log('connected', socket.id));</pre>

                    </div>

                    <div class="section">
                        <h2>Deployment & env</h2>
                        <p class="small">Required environment variables (Render / production)</p>
                        <ul class="small">
                            <li><code>MONGO_URI</code> — MongoDB connection string (Atlas)</li>
                            <li><code>JWT_SECRET</code> — secret used to sign/verify JWTs</li>
                            <li><code>FRONTEND_ORIGIN</code> — allowed CORS origin (or <code>*</code> for testing)</li>
                            <li><code>NODE_ENV</code> — production</li>
                        </ul>
                        <p class="small">Render: set env vars in the Render dashboard, push to GitHub, Render
                            auto-deploys. Socket.IO works on Render (wss/https).</p>
                    </div>

                </div>
            </div>

            <div class="section">
                <h2>Tips & Integration notes</h2>
                <ul class="small">
                    <li>After login, client should immediately open Socket.IO (auth: { token }). That is what marks the
                        user online.</li>
                    <li>Use rooms named by <code>userId</code> (server joins sockets to <code>userId</code>) and emit
                        with <code>io.to(userId).emit(...)</code> so multi-device works.</li>
                    <li>Always dedupe messages in the client by <code>_id</code> because server may emit the same
                        message to multiple rooms.</li>
                    <li>For scaling across instances add a Redis adapter (<code>@socket.io/redis-adapter</code>).</li>
                </ul>
            </div>

            <footer>
                <div class="small">This documentation page is served by the backend. Replace &lt;BASE&gt; with your base
                    URL. Remove this page or restrict access before going public if needed.</div>
            </footer>
        </div>
    </div>

    <!-- small JS helper to copy examples -->
    <script>
        // optional: click-to-copy for pre blocks (works if you want)
        document.querySelectorAll('pre.example').forEach(pre => {
            pre.addEventListener('click', () => {
                const t = pre.innerText;
                navigator.clipboard?.writeText(t).then(() => {
                    pre.style.outline = '2px solid rgba(96,165,250,0.2)';
                    setTimeout(() => pre.style.outline = '', 600);
                }).catch(() => { });
            });
        });
    </script>

</body>

</html>